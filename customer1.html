<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Surana Ashok Kumar Arvind Kumar | Mirchi Bazar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f1f8e9;margin:0;padding:10px}
.container{max-width:720px;margin:auto;background:#fff;padding:15px;border-radius:12px}
h2{text-align:center;color:#1b5e20}
label{font-weight:bold;margin-top:10px;display:block}
input,select,textarea,button{width:100%;padding:10px;margin-top:5px;font-size:16px;box-sizing:border-box}
button{background:#2e7d32;color:#fff;border:none;border-radius:25px;margin-top:15px;cursor:pointer}
table{width:100%;margin-top:10px;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#e8f5e9}

.input-grid { display: flex; gap: 10px; margin-top: 10px; }
.input-group { display: flex; flex-direction: column; flex: 1; }
.input-group label { margin-top: 0; font-size: 14px; }

#itemSearch { background-color: #fff9c4; border: 1px solid #fbc02d; margin-bottom: 5px; }

/* Modal for Confirmation */
#confirmOverlay {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;}
#confirmModal {background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto;}
</style>
</head>

<body>

<div id="confirmOverlay">
    <div id="confirmModal">
        <h3 style="text-align:center; color:#1b5e20;">Confirm Your Order</h3>
        <div id="confirmText"></div>
        <button onclick="finalSubmit()">‚úÖ Confirm & Send WhatsApp</button>
        <button style="background:#666;" onclick="document.getElementById('confirmOverlay').style.display='none'">‚ùå Edit Order</button>
    </div>
</div>

<div class="container">

<h2>üõí Surana Ashok Kumar Arvind Kumar</h2>

<div style="text-align:center;font-size:18px;margin-bottom:10px;">
 <a href="https://maps.app.goo.gl/exwWju9MgBr5epFV6" target="_blank" style="text-decoration:none;color:#0d47a1;">üìç Mirchi Bazar</a><br>
 <a href="tel:9462439993" style="text-decoration:none;color:#1b5e20;font-weight:bold;">üìû 9462439993</a>
</div>
<label>Name / ‡§®‡§æ‡§Æ *</label>
<input id="custName" oninput="this.value=this.value.replace(/[^a-zA-Z\s]/g,'')">

<label>Mobile / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ *</label>
<input id="custMobile" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

<label>Address / ‡§™‡§§‡§æ *</label>
<textarea id="custAddress"></textarea>

<label>Delivery Type</label>
<select id="deliveryType">
 <option>Home Delivery</option>
 <option>Pick from Shop</option>
</select>

<hr>

<label>Category</label>
<select id="category"></select>

<label>Item / ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ñ‡•ã‡§ú‡•á‡§Ç</label>
<input type="text" id="itemSearch" placeholder="üîç Type item name to search...">
<select id="item"></select>

<div class="input-grid">
  <div class="input-group">
    <label>Unit</label>
    <select id="unit"></select>
  </div>
  <div class="input-group">
    <label>Weight</label>
    <input id="qty" type="number" min="1">
  </div>
  <div class="input-group">
    <label>Packets</label>
    <input id="packetCount" type="number" min="1" value="1" placeholder="Packets">
  </div>
</div>

<button id="addBtn">Add Item</button>

<table>
<thead>
<tr><th>Item</th><th>Qty</th><th>Packets</th><th>‚ùå</th></tr>
</thead>
<tbody id="cartTable"></tbody>
</table>

<button id="orderBtn">Place Order & WhatsApp</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyDKzDGac5Zl1RZlZDnkeNZrMf6OGabSiRY",
 authDomain: "mewapeople-25844.firebaseapp.com",
 projectId: "mewapeople-25844",
 storageBucket: "mewapeople-25844.firebasestorage.app",
 messagingSenderId: "53407017674",
 appId: "1:53407017674:web:1667bb04862a76c02a6233"
});
const db=firebase.firestore();

const category=document.getElementById("category");
const item=document.getElementById("item");
const itemSearch=document.getElementById("itemSearch");
const qty=document.getElementById("qty");
const unit=document.getElementById("unit");
const packetCount=document.getElementById("packetCount");
const cartTable=document.getElementById("cartTable");

let items=[], cart=[];

/* LOAD DATA */
async function loadData(){
 const cs=await db.collection("categories").get();
 let categoriesData = [];
 cs.forEach(d => categoriesData.push(d.data()));

 // Feature: Sort Categories A-Z
 categoriesData.sort((a, b) => a.en.localeCompare(b.en));

 category.innerHTML="";
 categoriesData.forEach(c => {
  category.innerHTML+=`<option value="${c.en}">${c.en} / ${c.hi}</option>`;
 });

 const it=await db.collection("items").get();
 items=it.docs.map(d=>d.data());

 loadItems();
}
loadData();

category.onchange=function(){
 itemSearch.value = ""; 
 loadItems();
};

/* FILTER AND RENDER ITEMS */
function loadItems(){
 const searchText = itemSearch.value.toLowerCase();
 let filtered = items.filter(i => i.cat === category.value);
 
 if(searchText) {
  filtered = filtered.filter(i => 
    i.en.toLowerCase().includes(searchText) || 
    i.hi.toLowerCase().includes(searchText)
  );
 }

 // Feature: Sort Items A-Z
 filtered.sort((a, b) => a.en.localeCompare(b.en));

 item.innerHTML="";
 filtered.forEach(i=>{
  item.innerHTML+=`<option value="${i.en}">${i.en} / ${i.hi}</option>`;
 });
 
 loadQtyUnit();
}

itemSearch.oninput = loadItems;
item.onchange=loadQtyUnit;

function loadQtyUnit(){
 const i=items.find(x=>x.en===item.value);
 if(!i) return;

 unit.innerHTML="";
 (i.units || []).forEach(u=>{
  unit.innerHTML+=`<option value="${u}">${u}</option>`;
 });

 applyLimits();
}

unit.onchange = applyLimits;

function applyLimits() {
  const i = items.find(x => x.en === item.value);
  if (!i) return;

  const selectedUnit = unit.value.toLowerCase();
  
  if (selectedUnit === "gm" || selectedUnit === "g") {
    qty.min = 1;
    qty.max = 1000;
  } else {
    qty.min = 1;
    qty.max = i.maxQty || 9999;
  }
  qty.value = i.minQty || 1;
}

/* ADD ITEM */
addBtn.onclick=function(){
 const i=items.find(x=>x.en===item.value);
 if(!i) return;

 // Feature: Duplicate Check
 const duplicate = cart.find(c => c.hi === i.hi);
 if(duplicate) { alert("This item is already added to your list."); return; }

 const q=Number(qty.value);
 if(q < qty.min || q > qty.max){
  alert(`Quantity must be between ${qty.min} and ${qty.max}`);
  return;
 }

 cart.push({
  hi:i.hi,
  qty:q,
  unit:unit.value,
  packets:packetCount.value
 });
 renderCart();
};

function renderCart(){
 cartTable.innerHTML="";
 cart.forEach((c,i)=>{
  cartTable.innerHTML+=`
   <tr>
    <td>${c.hi}</td>
    <td>${c.qty} ${c.unit}</td>
    <td>${c.packets}</td>
    <td onclick="removeItem(${i})" style="cursor:pointer">‚ùå</td>
   </tr>`;
 });
}
window.removeItem=i=>{cart.splice(i,1);renderCart();};

/* MODAL STEP */
orderBtn.onclick=function(){
 const name=custName.value.trim();
 const mobile=custMobile.value.trim();
 const address=custAddress.value.trim();

 if(!name||!mobile||!address){ alert("All fields are mandatory"); return; }
 if(cart.length===0){ alert("Add at least one item"); return; }

 let summary = `<p><b>Name:</b> ${name}</p><p><b>Items:</b></p><ul>`;
 cart.forEach(c => { summary += `<li>${c.hi} (${c.qty} ${c.unit})</li>`; });
 summary += "</ul>";
 
 document.getElementById("confirmText").innerHTML = summary;
 document.getElementById("confirmOverlay").style.display = "flex";
};

/* FINAL SUBMIT */
window.finalSubmit = async function(){
 const name=custName.value.trim();
 const mobile=custMobile.value.trim();
 const address=custAddress.value.trim();
 const code="ORD"+Date.now().toString().slice(-4);
 const time=new Date().toLocaleString();
 
 const itemsDbText=cart.map(i=>`${i.hi} ${i.qty} ${i.unit}, ‡§™‡•à‡§ï‡•á‡§ü: ${i.packets}`).join("\n");
 const waItemsText=cart.map((i,idx)=>`*${idx+1}.* ${i.hi}: ${i.qty}${i.unit} (${i.packets} Pkt)`).join("\n");

 try {
    await db.collection("orders").add({
     code,name,mobile,address,
     type:deliveryType.value,
     items:itemsDbText,time
    });

    const waMsg = `*‡§®‡§Ø‡§æ ‡§ë‡§∞‡•ç‡§°‡§∞: #${code}*\nüë§ *‡§ó‡•ç‡§∞‡§æ‡§π‡§ï:* ${name}\nüìû *‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:* ${mobile}\nüìç *‡§™‡§§‡§æ:* ${address}\n\nüõí *‡§∏‡§æ‡§Æ‡§æ‡§®:* \n${waItemsText}`;
    window.location.href="https://wa.me/919462439993?text="+encodeURIComponent(waMsg);
 } catch(e) { alert("Error: " + e.message); }
};
</script>

</body>
</html>