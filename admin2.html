<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel - Surana Ashok Kumar Arvind Kumar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f1f8e9;margin:0;padding:15px}
.container{max-width:1100px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
h1{text-align:center;color:#1b5e20;margin-bottom:20px}
nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;justify-content:center}
nav button{padding:12px 20px;border:none;border-radius:25px;background:#2e7d32;color:#fff;cursor:pointer;font-weight:bold;transition:0.3s}
nav button:hover{background:#1b5e20}
section{display:none}
section.active{display:block}
label{font-weight:bold; display:block; margin-top:15px; color:#333}
input,select{width:100%;padding:12px;margin-top:5px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:14px}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #ddd;padding:12px;text-align:center}
th{background:#e8f5e9;color:#2e7d32;font-weight:bold}
.delete{color:#d32f2f;cursor:pointer; font-weight:bold; font-size:18px}
.edit-btn{color:#0d47a1; cursor:pointer; font-weight:bold; margin-right:10px}
.action-btn {background:#2e7d32; color:white; padding:15px; width:100%; border:none; border-radius:6px; margin-top:20px; cursor:pointer; font-size:16px; font-weight:bold}
.action-btn:hover{background:#1b5e20}
.print-btn {background:#0d47a1; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold}
.search-bar{margin-bottom:10px; border:2px solid #2e7d32; background: #fff url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css');}
</style>
</head>

<body>
<div class="container">

<h1>üõí Admin Panel - Surana Ashok Kumar</h1>

<section id="loginSection" class="active">
<h3>Admin Secure Access</h3>
<input id="adminId" placeholder="Admin ID">
<input id="adminPass" type="password" placeholder="Password">
<button class="action-btn" onclick="login()">Login to Dashboard</button>
</section>

<section id="mainSection">
<nav>
<button onclick="showTab('cat')">Categories</button>
<button onclick="showTab('item')">Manage Items</button>
<button onclick="showTab('orders')">View Orders</button>
<button onclick="showTab('cred')">Settings</button>
<button onclick="showTab('customers')">Customers & Marketing</button>
</nav>

<section id="cred">
<h3>Update Admin Credentials</h3>
<input id="newId" placeholder="New Admin ID">
<input id="newPass" placeholder="New Password">
<button class="action-btn" onclick="changeCred()">Update Credentials</button>
</section>

<section id="cat">
<h3 id="catFormTitle">Manage Categories</h3>
<input type="hidden" id="editCatId">
<div style="display:flex; gap:10px;">
  <input id="catEn" placeholder="Category (English)">
  <input id="catHi" placeholder="Category (Hindi)">
</div>
<button id="catSubmitBtn" class="action-btn" onclick="addCategory()">Add Category</button>
<button id="cancelCatEditBtn" class="action-btn" style="display:none; background:#666;" onclick="resetCatForm()">Cancel Edit</button>

<hr style="margin-top:30px">
<input type="text" id="searchCat" class="search-bar" placeholder="üîç Search Category..." onkeyup="filterCategories()">
<table>
<thead><tr><th>English</th><th>Hindi</th><th>Action</th></tr></thead>
<tbody id="catTable"></tbody>
</table>
</section>

<section id="item">
<h3 id="itemFormTitle">Add New Shop Item</h3>
<input type="hidden" id="editItemId">

<label>1. Select Category</label>
<select id="catSelect"></select>

<div style="display:flex; gap:10px;">
  <div style="flex:1">
    <label>2. Item Name (English)</label>
    <input id="itemEn" placeholder="e.g. Cashew Whole">
  </div>
  <div style="flex:1">
    <label>3. Item Name (Hindi)</label>
    <input id="itemHi" placeholder="e.g. ‡§ï‡§æ‡§ú‡•Ç ‡§∏‡§æ‡§¨‡•Å‡§§">
  </div>
</div>

<label>4. Units (Select up to 2)</label>
<div style="display:flex; gap:10px;">
  <select id="unit1">
    <option value="">-- Main Unit --</option>
    <option value="kg">Kg / ‡§ï‡§ø‡§≤‡•ã</option>
    <option value="gm">Gram / ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
    <option value="packet">Packet / ‡§™‡•à‡§ï‡•á‡§ü</option>
    <option value="piece">Piece / ‡§™‡•Ä‡§∏</option>
    <option value="litre">litre / ‡§≤‡•Ä‡§ü‡§∞</option>
  </select>
  <select id="unit2">
    <option value="">-- Optional Unit --</option>
    <option value="kg">Kg / ‡§ï‡§ø‡§≤‡•ã</option>
    <option value="gm">Gram / ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
    <option value="packet">Packet / ‡§™‡•à‡§ï‡•á‡§ü</option>
    <option value="piece">Piece / ‡§™‡•Ä‡§∏</option>
    <option value="litre">litre / ‡§≤‡•Ä‡§ü‡§∞</option>
  </select>
</div>

<div style="display:flex; gap:10px;">
  <div style="flex:1">
    <label>5. Min Order Qty</label>
    <input id="minQty" type="number" value="1">
  </div>
  <div style="flex:1">
    <label>6. Max Order Qty</label>
    <input id="maxQty" type="number" value="100">
  </div>
</div>

<button id="submitBtn" class="action-btn" onclick="addItem()">Add Item to Live Shop</button>
<button id="cancelEditBtn" class="action-btn" style="display:none; background:#666;" onclick="resetItemForm()">Cancel Edit</button>

<hr style="margin-top:40px">
<h3>Live Item Inventory</h3>
<input type="text" id="searchItem" class="search-bar" placeholder="üîç Search item by name or category..." onkeyup="filterItems()">

<table>
<thead>
<tr>
<th>Category</th>
<th>Item (Eng/Hi)</th>
<th>Units</th>
<th>Limit</th>
<th>Action</th>
</tr>
</thead>
<tbody id="itemTable"></tbody>
</table>
</section>

<section id="orders">
<h3>Recent Customer Orders</h3>
<button class="action-btn" style="margin-bottom:20px;" onclick="loadOrders()">üîÑ Refresh Order List</button>
<table>
<thead>
<tr>
<th>Order #</th>
<th>Customer</th>
<th>Contact</th>
<th>Items Summary</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody id="orderTable"></tbody>
</table>
</section>
</section>
</div>

<section id="customers">
  <h3>Customer Database & Re-engagement</h3>
  <p><small>Highlighting customers who haven't ordered in 15+ days.</small></p>
  <table>
    <thead>
      <tr>
        <th>Customer Name</th>
        <th>Mobile</th>
        <th>Last Order</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="customerTable"></tbody>
  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyDKzDGac5Zl1RZlZDnkeNZrMf6OGabSiRY",
 authDomain: "mewapeople-25844.firebaseapp.com",
 projectId: "mewapeople-25844",
 storageBucket: "mewapeople-25844.firebasestorage.app",
 messagingSenderId: "53407017674",
 appId: "1:53407017674:web:1667bb04862a76c02a6233"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allItems = []; 
let allCategories = [];

window.login = async function(){
 const id = document.getElementById("adminId").value;
 const pass = document.getElementById("adminPass").value;
 try {
  let snap = await getDoc(doc(db,"config","login"));
  if(id === snap.data().id && pass === snap.data().pass){
   document.getElementById("loginSection").style.display="none";
   document.getElementById("mainSection").style.display="block";
   loadAll();
  } else { alert("Invalid Credentials"); }
 } catch(e) { alert("Database Error: " + e.message); }
};

window.changeCred = async function(){
 const id = document.getElementById("newId").value;
 const pass = document.getElementById("newPass").value;
 if(!id || !pass) return alert("Please fill both fields");
 await setDoc(doc(db,"config","login"),{id, pass});
 alert("Admin Login Updated!");
};

window.showTab = function(id){
 document.querySelectorAll("#mainSection > section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
};

// CATEGORY LOGIC
window.addCategory = async function(){
 const id = document.getElementById("editCatId").value;
 const en = document.getElementById("catEn").value.trim();
 const hi = document.getElementById("catHi").value.trim();
 if(!en || !hi) return alert("Both English and Hindi names required");

 if(!id){
    const exists = allCategories.find(c => c.en.toLowerCase() === en.toLowerCase() || c.hi === hi);
    if(exists) return alert("Error: This Category already exists!");
 }

 try {
  if(id){
    await updateDoc(doc(db, "categories", id), {en, hi});
    alert("Category Updated!");
  } else {
    await addDoc(collection(db,"categories"), {en, hi});
    alert("Category Added!");
  }
  resetCatForm();
  loadCategories();
 } catch(e) { alert("Error: " + e.message); }
};

async function loadCategories(){
 let snap = await getDocs(collection(db,"categories"));
 allCategories = [];
 snap.forEach(d => allCategories.push({id:d.id, ...d.data()}));
 allCategories.sort((a,b)=> a.en.localeCompare(b.en));
 renderCatTable(allCategories);
 updateCatDropdown();
}

function renderCatTable(data){
 const table = document.getElementById("catTable");
 table.innerHTML = "";
 data.forEach(c=>{
  table.innerHTML += `<tr><td>${c.en}</td><td>${c.hi}</td>
  <td>
    <span class="edit-btn" onclick="editCategory('${c.id}')">‚úèÔ∏è Edit</span>
    <span class="delete" onclick="delCat('${c.id}')">‚ùå</span>
  </td></tr>`;
 });
}

window.editCategory = function(id){
  const cat = allCategories.find(c => c.id === id);
  document.getElementById("editCatId").value = cat.id;
  document.getElementById("catEn").value = cat.en;
  document.getElementById("catHi").value = cat.hi;
  document.getElementById("catFormTitle").innerText = "Editing: " + cat.en;
  document.getElementById("catSubmitBtn").innerText = "Update Category";
  document.getElementById("cancelCatEditBtn").style.display = "block";
}

window.resetCatForm = function(){
  document.getElementById("editCatId").value = "";
  document.getElementById("catEn").value = "";
  document.getElementById("catHi").value = "";
  document.getElementById("catFormTitle").innerText = "Manage Categories";
  document.getElementById("catSubmitBtn").innerText = "Add Category";
  document.getElementById("cancelCatEditBtn").style.display = "none";
}

window.filterCategories = function(){
  const val = document.getElementById("searchCat").value.toLowerCase();
  const filtered = allCategories.filter(c => c.en.toLowerCase().includes(val) || c.hi.includes(val));
  renderCatTable(filtered);
}

function updateCatDropdown(){
  const select = document.getElementById("catSelect");
  select.innerHTML = "<option value=''>-- Select Category --</option>";
  allCategories.forEach(c => {
    select.innerHTML += `<option value="${c.en}">${c.en} / ${c.hi}</option>`;
  });
}

// ITEM LOGIC
window.addItem = async function(){
 const id = document.getElementById("editItemId").value;
 const cat = document.getElementById("catSelect").value;
 const en = document.getElementById("itemEn").value.trim();
 const hi = document.getElementById("itemHi").value.trim();
 const u1 = document.getElementById("unit1").value;
 const u2 = document.getElementById("unit2").value;
 const min = document.getElementById("minQty").value;
 const max = document.getElementById("maxQty").value;

 if(!cat || !en || !hi || !u1) return alert("Please fill all required fields");

 if(!id){
    const exists = allItems.find(i => i.en.toLowerCase() === en.toLowerCase() || i.hi === hi);
    if(exists) return alert("Error: This item name (English or Hindi) already exists!");
 }

 const itemData = { cat, en, hi, units: [u1, u2].filter(u=>u!==""), minQty: Number(min), maxQty: Number(max) };

 try {
  if(id) {
    await updateDoc(doc(db, "items", id), itemData);
    alert("Item Updated!");
  } else {
    await addDoc(collection(db,"items"), itemData);
    alert("Item Added!");
  }
  resetItemForm();
  loadItems();
 } catch(e) { alert(e.message); }
};

async function loadItems(){
 let snap = await getDocs(collection(db,"items"));
 allItems = [];
 snap.forEach(d => allItems.push({id:d.id, ...d.data()}));
 allItems.sort((a,b)=> a.en.localeCompare(b.en));
 renderItemTable(allItems);
}

function renderItemTable(data){
 const table = document.getElementById("itemTable");
 table.innerHTML = "";
 data.forEach(i=>{
  table.innerHTML += `<tr>
   <td>${i.cat}</td>
   <td>${i.en}<br><small>${i.hi}</small></td>
   <td>${(i.units||[]).join(", ")}</td>
   <td>${i.minQty}-${i.maxQty}</td>
   <td>
     <span class="edit-btn" onclick="editItem('${i.id}')">‚úèÔ∏è Edit</span>
     <span class="delete" onclick="delItem('${i.id}')">‚ùå</span>
   </td></tr>`;
 });
}

window.editItem = function(id){
  const item = allItems.find(i => i.id === id);
  document.getElementById("editItemId").value = item.id;
  document.getElementById("catSelect").value = item.cat;
  document.getElementById("itemEn").value = item.en;
  document.getElementById("itemHi").value = item.hi;
  document.getElementById("unit1").value = item.units[0] || "";
  document.getElementById("unit2").value = item.units[1] || "";
  document.getElementById("minQty").value = item.minQty;
  document.getElementById("maxQty").value = item.maxQty;
  document.getElementById("itemFormTitle").innerText = "Editing: " + item.en;
  document.getElementById("submitBtn").innerText = "Update Item Details";
  document.getElementById("cancelEditBtn").style.display = "block";
  window.scrollTo(0,0);
}

window.resetItemForm = function(){
  document.getElementById("editItemId").value = "";
  document.getElementById("itemEn").value = "";
  document.getElementById("itemHi").value = "";
  document.getElementById("itemFormTitle").innerText = "Add New Shop Item";
  document.getElementById("submitBtn").innerText = "Add Item to Live Shop";
  document.getElementById("cancelEditBtn").style.display = "none";
}

window.filterItems = function(){
  const val = document.getElementById("searchItem").value.toLowerCase();
  const filtered = allItems.filter(i => 
    i.en.toLowerCase().includes(val) || 
    i.hi.includes(val) || 
    i.cat.toLowerCase().includes(val)
  );
  renderItemTable(filtered);
}

window.delCat = async (id) => { if(confirm("Delete category?")){ await deleteDoc(doc(db,"categories",id)); loadCategories(); } };
window.delItem = async (id) => { if(confirm("Delete item?")){ await deleteDoc(doc(db,"items",id)); loadItems(); } };
window.delOrder = async (id) => { if(confirm("Delete order?")){ await deleteDoc(doc(db,"orders",id)); loadOrders(); } };

window.loadOrders = async function(){
 const table = document.getElementById("orderTable");
 let snap = await getDocs(collection(db,"orders"));
 table.innerHTML = "";
 snap.forEach(d=>{
  let o = d.data();
  const orderData = JSON.stringify(o).replace(/'/g, "\\'"); 
  table.innerHTML += `<tr>
   <td>${o.code}</td><td>${o.name}</td><td>${o.mobile}</td>
   <td><small>${o.items ? o.items.substring(0,50) : ""}...</small></td>
   <td>${o.time}</td>
   <td><button class="print-btn" onclick='printOrder(${orderData})'>Print Bill</button>
   <span class="delete" onclick="delOrder('${d.id}')" style="margin-left:10px;">‚ùå</span></td></tr>`;
 });
};

window.printOrder = function(o) {
  const printWindow = window.open('', '_blank');
  let itemRows = "";
  if(!o.items) return alert("Empty Order");
  const lines = o.items.split('\n');
  lines.forEach(line => {
    if(line.trim() === "") return;
    const mainParts = line.split(',');
    const itemAndQty = mainParts[0] || "";
    const packetPart = mainParts[1] ? mainParts[1].replace('‡§™‡•à‡§ï‡•á‡§ü:', '').trim() : "1";
    const parts = itemAndQty.trim().split(' ');
    const unitPart = parts.pop(); // Gets 'kg' or 'gm'
    const qtyPart = parts.pop();  // Gets the number (e.g. '500')
    const itemName = parts.join(' '); // Joins everything else back (e.g. 'Cashew Whole')
    const qtyValue = qtyPart + " " + unitPart;
    itemRows += `<tr><td style="border:1px solid #000;padding:12px;text-align:left;">${itemName}</td><td style="border:1px solid #000;padding:12px;">${qtyValue}</td><td style="border:1px solid #000;padding:12px;">${packetPart}</td><td style="border:1px solid #000;padding:12px;"></td></tr>`;
  });
  for(let i=0; i<4; i++) {
    itemRows += `<tr style="height:45px;"><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td></tr>`;
  }
  printWindow.document.write(`
    <html><head><title>Order_${o.code}</title><style>
    body{font-family:Arial;padding:10px}.bill-container{border:2px solid #000;padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:15px}th,td{border:1px solid #000;padding:8px;text-align:center}
    th:nth-child(1),td:nth-child(1){width:45%}th:nth-child(2),td:nth-child(2){width:15%}
    th:nth-child(3),td:nth-child(3){width:15%}th:nth-child(4),td:nth-child(4){width:25%}
    .info-table{border:none;width:100%;margin:15px 0}.info-table td{border:none;text-align:left;font-size:14px}
    </style></head><body onload="window.print()"><div class="bill-container">
    <div style="text-align:center;border-bottom:2px double #000;padding-bottom:10px">
    <h1 style="margin:0">SURANA ASHOK KUMAR ARVIND KUMAR</h1>
    <p style="margin:5px">‡§Æ‡§ø‡§∞‡•ç‡§ö‡•Ä ‡§¨‡§æ‡§ú‡§æ‡§∞, ‡§ú‡•ã‡§ß‡§™‡•Å‡§∞ | ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤: 9462439993, 9587005556</p></div>
    <table class="info-table"><tr><td><strong>Order No:</strong> ${o.code}</td><td style="text-align:right;"><strong>Date:</strong> ${o.time}</td></tr>
    <tr><td><strong>Customer:</strong> ${o.name}</td><td style="text-align:right;"><strong>Delivery:</strong> ${o.type || 'Home Delivery'}</td></tr>
    <tr><td><strong>Mobile:</strong> ${o.mobile}</td><td style="text-align:right;"><strong>Address:</strong> ${o.address}</td></tr></table>
    <table><thead><tr style="background:#f2f2f2;"><th>Item (‡§∏‡§æ‡§Æ‡§æ‡§®)</th><th>Qty</th><th>Pkts</th><th>Price (‡§ï‡•Ä‡§Æ‡§§)</th></tr></thead>
    <tbody>${itemRows}</tbody></table>
    <div style="margin-top:30px;text-align:right;"><p style="font-size:18px;"><strong>TOTAL AMOUNT: ‚Çπ _______________</strong></p></div>
    </div></body></html>`);
  printWindow.document.close();
};

// Function to check and update customer database (Call this inside your order placement logic)
async function syncCustomer(orderData) {
  const customerRef = doc(db, "customers", orderData.mobile);
  await setDoc(customerRef, {
    name: orderData.name,
    mobile: orderData.mobile,
    address: orderData.address,
    lastOrderDate: new Date().toISOString() // Saves current date
  }, { merge: true });
}

// Function to load the Customer Tab
window.loadCustomers = async function() {
  const table = document.getElementById("customerTable");
  const snap = await getDocs(collection(db, "customers"));
  table.innerHTML = "";
  
  const fifteenDaysAgo = new Date();
  fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);

  snap.forEach(d => {
    let c = d.data();
    let lastDate = new Date(c.lastOrderDate);
    let isInactive = lastDate < fifteenDaysAgo;
    
    // WhatsApp Message
    let msg = `Hi ${c.name}, we haven't heard from you in a while! Check out our latest items at Surana Ashok Kumar.`;
    let waLink = `https://wa.me/91${c.mobile}?text=${encodeURIComponent(msg)}`;

    table.innerHTML += `
      <tr style="${isInactive ? 'background:#ffebee' : ''}">
        <td>${c.name}</td>
        <td>${c.mobile}</td>
        <td>${lastDate.toLocaleDateString()}</td>
        <td>${isInactive ? 'üî¥ Inactive' : 'üü¢ Active'}</td>
        <td>
          <a href="${waLink}" target="_blank" class="print-btn" style="text-decoration:none; background:#25D366;">
            Send WhatsApp
          </a>
        </td>
      </tr>`;
  });
};
async function loadAll(){ loadCategories(); loadItems(); loadOrders(); }
</script>

<script src="https://www.google.com/jsapi"></script>
<script>
google.load("elements","1",{packages:"transliteration"});
google.setOnLoadCallback(()=>{
 var control=new google.elements.transliteration.TransliterationControl({sourceLanguage:'en', destinationLanguage:['hi'], transliterationEnabled:true});
 control.makeTransliteratable(['catHi','itemHi']);
});
</script>

</body>
</html>