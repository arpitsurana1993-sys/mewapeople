<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Place Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f1f8e9;padding:15px}
.container{max-width:600px;margin:auto;background:#fff;padding:20px;border-radius:12px}
h2{text-align:center;color:#1b5e20}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{background:#2e7d32;color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
.qtyRow{display:flex;gap:6px}
.qtyRow input,.qtyRow select{width:100%}
.popup{
 display:none;
 position:fixed;
 top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,0.5);
 align-items:center;
 justify-content:center;
}
.popup div{
 background:#fff;
 padding:25px;
 border-radius:10px;
 font-size:18px;
 color:#1b5e20;
}
</style>
</head>

<body>
<div class="container">

<h2>üõí Place Order</h2>

<input id="custName" placeholder="Name">
<input id="custMobile" placeholder="Mobile Number" type="tel">
<input id="custAddress" placeholder="Address">

<select id="category"></select>
<select id="item"></select>

<div class="qtyRow">
 <input id="qty" type="number" min="1" placeholder="Weight">
 <select id="unit">
  <option value="‡§ó‡•ç‡§∞‡§æ‡§Æ">Gram / ‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
  <option value="‡§ï‡§ø‡§≤‡•ã">Kg / ‡§ï‡§ø‡§≤‡•ã</option>
 </select>
</div>

<button id="addBtn">Add Item</button>

<table>
<thead>
<tr><th>Item</th><th>Qty</th><th>‚ùå</th></tr>
</thead>
<tbody id="cartTable"></tbody>
</table>

<select id="deliveryType">
 <option value="Pickup">Pickup</option>
 <option value="Home Delivery">Home Delivery</option>
</select>

<button id="orderBtn">Place Order</button>

</div>

<!-- SUCCESS POPUP -->
<div class="popup" id="successPopup">
 <div>‚úÖ Order placed successfully!</div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyDKzDGac5Zl1RZlZDnkeNZrMf6OGabSiRY",
 authDomain: "mewapeople-25844.firebaseapp.com",
 projectId: "mewapeople-25844",
 storageBucket: "mewapeople-25844.firebasestorage.app",
 messagingSenderId: "53407017674",
 appId: "1:53407017674:web:1667bb04862a76c02a6233"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allItems=[], cart=[], lastOrderKey="";

/* LOAD DATA */
async function loadData(){
 let cSnap = await getDocs(collection(db,"categories"));
 cSnap.forEach(d=>{
  let c=d.data();
  category.innerHTML+=`<option value="${c.en}">${c.en}/${c.hi}</option>`;
 });

 let iSnap = await getDocs(collection(db,"items"));
 iSnap.forEach(d=>allItems.push(d.data()));

 loadItems();
}
loadData();

function loadItems(){
 item.innerHTML="";
 allItems.filter(i=>i.cat===category.value)
 .forEach(i=>{
  item.innerHTML+=`<option value="${i.en}">${i.en} / ${i.hi}</option>`;
 });
}
category.onchange=loadItems;

/* AUTO CONVERT GM ‚Üí KG */
function formatQty(qty,unit){
 qty=parseFloat(qty);
 if(unit==="‡§ó‡•ç‡§∞‡§æ‡§Æ" && qty>=1000){
  return {qty:(qty/1000).toFixed(2), unit:"‡§ï‡§ø‡§≤‡•ã"};
 }
 return {qty,unit};
}

/* ADD ITEM */
addBtn.onclick=function(){
 let s=allItems.find(i=>i.en===item.value);
 if(!s)return;

 let f=formatQty(qty.value,unit.value);

 cart.push({hi:s.hi, qty:f.qty, unit:f.unit});
 renderCart();
};

/* RENDER CART */
function renderCart(){
 cartTable.innerHTML="";
 cart.forEach((c,i)=>{
  cartTable.innerHTML+=`
  <tr>
   <td>${c.hi}</td>
   <td>${c.qty} ${c.unit}</td>
   <td onclick="removeItem(${i})">‚ùå</td>
  </tr>`;
 });
}
window.removeItem=i=>{cart.splice(i,1);renderCart();};

/* PLACE ORDER */
orderBtn.onclick=async function(){
 let name=custName.value.trim();
 let mobile=custMobile.value.trim();
 let address=custAddress.value.trim();

 if(!name||!mobile||!address){
  alert("Fill all mandatory fields");
  return;
 }

 if(cart.length===0){
  alert("Add at least one item");
  return;
 }

 let orderKey=name+mobile;
 if(orderKey===lastOrderKey){
  alert("Order already placed");
  return;
 }
 lastOrderKey=orderKey;

 let itemsText=cart.map(c=>`${c.hi} ${c.qty} ${c.unit}`).join("\n");

 await addDoc(collection(db,"orders"),{
  name,mobile,address,
  type:deliveryType.value,
  items:itemsText,
  time:new Date().toLocaleString()
 });

 /* WHATSAPP */
 let msg=`*New Order*\n\n${itemsText}\n\nName: ${name}\nMobile: ${mobile}\nAddress: ${address}`;
 window.open(`https://wa.me/91XXXXXXXXXX?text=${encodeURIComponent(msg)}`);

 /* SUCCESS POPUP */
 successPopup.style.display="flex";
 setTimeout(()=>{
  successPopup.style.display="none";
  cart=[];
  renderCart();
 },2000);
};
</script>

</body>
</html>
