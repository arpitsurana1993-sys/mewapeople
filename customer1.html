<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Surana Ashok Kumar Arvind Kumar | Mirchi Bazar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial, sans-serif;background:#f1f8e9;margin:0;padding:10px}
.container{max-width:720px;margin:auto;background:#fff;padding:15px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,0.1)}
h2{text-align:center;color:#1b5e20;margin-bottom:5px}
.shop-info{text-align:center;font-size:14px;margin-bottom:15px;color:#555}
label{font-weight:bold;margin-top:12px;display:block;color:#333}
input,select,textarea,button{width:100%;padding:12px;margin-top:5px;font-size:16px;box-sizing:border-box;border:1px solid #ccc;border-radius:8px}
button{background:#2e7d32;color:#fff;border:none;border-radius:25px;margin-top:15px;cursor:pointer;font-weight:bold}
button:hover{background:#1b5e20}
table{width:100%;margin-top:15px;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:10px;text-align:center}
th{background:#e8f5e9;color:#2e7d32}

.input-grid {display: flex;gap: 10px;margin-top: 10px}
.input-group {display: flex;flex-direction: column;flex: 1}
.input-group label {margin-top: 0;font-size: 13px}

#itemSearch {background-color: #fff9c4;border: 2px solid #fbc02d;font-weight: bold}
#orderBtn {background:#0d47a1;height: 55px;font-size: 18px}
.delete-btn {color:#d32f2f; cursor:pointer; font-size: 20px}
</style>
</head>

<body>
<div class="container">

<h2>ЁЯЫТ Surana Ashok Kumar</h2>
<div class="shop-info">
    ЁЯУН рдорд┐рд░реНрдЪреА рдмрд╛рдЬрд╛рд░, рдЬреЛрдзрдкреБрд░ | ЁЯУЮ 9462439993
</div>

<label>Customer Name / рдирд╛рдо *</label>
<input id="custName" placeholder="Enter your name" oninput="this.value=this.value.replace(/[^a-zA-Z\s]/g,'')">

<label>Mobile / рдореЛрдмрд╛рдЗрд▓ *</label>
<input id="custMobile" inputmode="numeric" placeholder="10 digit mobile number" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

<label>Address / рдкрддрд╛ *</label>
<textarea id="custAddress" rows="2" placeholder="Full address for delivery"></textarea>

<label>Delivery Type</label>
<select id="deliveryType">
 <option>Home Delivery</option>
 <option>Pick from Shop</option>
</select>

<hr style="margin-top:20px; border:0; border-top:1px solid #eee">

<label>1. Select Category</label>
<select id="category"></select>

<label>2. Search & Select Item</label>
<input type="text" id="itemSearch" placeholder="ЁЯФН Type item name (English or Hindi)...">
<select id="item" style="margin-top:8px"></select>

<div class="input-grid">
  <div class="input-group">
    <label>Unit</label>
    <select id="unit"></select>
  </div>
  <div class="input-group">
    <label>Weight/Qty</label>
    <input id="qty" type="number" min="1">
  </div>
  <div class="input-group">
    <label>Packets</label>
    <input id="packetCount" type="number" min="1" value="1">
  </div>
</div>

<button id="addBtn">тЮХ Add to List</button>

<table>
<thead>
<tr><th>Item</th><th>Qty</th><th>Pkt</th><th>Action</th></tr>
</thead>
<tbody id="cartTable"></tbody>
</table>

<button id="orderBtn">тЬЕ Place Order on WhatsApp</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// INITIALIZE FIREBASE
firebase.initializeApp({
 apiKey: "AIzaSyDKzDGac5Zl1RZlZDnkeNZrMf6OGabSiRY",
 authDomain: "mewapeople-25844.firebaseapp.com",
 projectId: "mewapeople-25844",
 storageBucket: "mewapeople-25844.firebasestorage.app",
 messagingSenderId: "53407017674",
 appId: "1:53407017674:web:1667bb04862a76c02a6233"
});
const db=firebase.firestore();

const categoryBox=document.getElementById("category");
const itemBox=document.getElementById("item");
const itemSearch=document.getElementById("itemSearch");
const qtyBox=document.getElementById("qty");
const unitBox=document.getElementById("unit");
const packetBox=document.getElementById("packetCount");
const cartTable=document.getElementById("cartTable");

let itemsList=[], cart=[];

/* LOAD CATEGORIES & ITEMS */
async function loadData(){
 try {
  const catSnap = await db.collection("categories").get();
  let categoriesData = [];
  catSnap.forEach(d => categoriesData.push(d.data()));
  
  // Alphabetical Sort
  categoriesData.sort((a, b) => a.en.localeCompare(b.en));

  categoryBox.innerHTML = "<option value=''>-- Choose Category --</option>";
  categoriesData.forEach(c => {
    categoryBox.innerHTML += `<option value="${c.en}">${c.en} / ${c.hi}</option>`;
  });

  const itemSnap = await db.collection("items").get();
  itemsList = itemSnap.docs.map(d=>d.data());
 } catch(e) { console.error("Load Error: ", e); }
}
loadData();

categoryBox.onchange = () => {
  itemSearch.value = "";
  renderFilteredItems();
};

itemSearch.oninput = renderFilteredItems;

/* RENDER ITEMS BASED ON SEARCH/CATEGORY */
function renderFilteredItems(){
 const searchText = itemSearch.value.toLowerCase();
 const selectedCat = categoryBox.value;

 let filtered = itemsList;

 // Filter by category if selected
 if(selectedCat) {
    filtered = filtered.filter(i => i.cat === selectedCat);
 }
 
 // Filter by Search Text
 if(searchText) {
  filtered = filtered.filter(i => 
    i.en.toLowerCase().includes(searchText) || 
    (i.hi && i.hi.toLowerCase().includes(searchText))
  );
 }

 // Sort A-Z
 filtered.sort((a, b) => a.en.localeCompare(b.en));

 itemBox.innerHTML = "";
 filtered.forEach(i => {
  itemBox.innerHTML += `<option value="${i.en}">${i.en} / ${i.hi}</option>`;
 });
 
 updateUnitsAndLimits();
}

itemBox.onchange = updateUnitsAndLimits;

function updateUnitsAndLimits(){
 const i = itemsList.find(x => x.en === itemBox.value);
 if(!i) return;

 unitBox.innerHTML = "";
 (i.units || []).forEach(u => {
  unitBox.innerHTML += `<option value="${u}">${u}</option>`;
 });

 qtyBox.value = i.minQty || 1;
}

/* ADD TO CART */
document.getElementById("addBtn").onclick = function(){
 const i = itemsList.find(x => x.en === itemBox.value);
 if(!i) return alert("Select an item first");

 const q = Number(qtyBox.value);
 if(q <= 0) return alert("Invalid Quantity");

 cart.push({
  en: i.en,
  hi: i.hi,
  qty: q,
  unit: unitBox.value,
  packets: packetBox.value
 });
 renderCart();
};

function renderCart(){
 cartTable.innerHTML = "";
 cart.forEach((c, index) => {
  cartTable.innerHTML += `
   <tr>
    <td>${c.hi}<br><small>${c.en}</small></td>
    <td>${c.qty} ${c.unit}</td>
    <td>${c.packets}</td>
    <td class="delete-btn" onclick="removeItem(${index})">ЁЯЧСя╕П</td>
   </tr>`;
 });
}

window.removeItem = i => { cart.splice(i,1); renderCart(); };

/* SUBMIT ORDER */
document.getElementById("orderBtn").onclick = async function() {
    const name = custName.value.trim();
    const mobile = custMobile.value.trim();
    const address = custAddress.value.trim();
    const delivery = deliveryType.value;

    if (!name || !mobile || !address) {
        alert("All fields are mandatory");
        return;
    }
    if (cart.length === 0) {
        alert("Add at least one item");
        return;
    }

    const code = "ORD" + Date.now().toString().slice(-6); // Shortened Order Code
    const time = new Date().toLocaleString('en-IN', { hour12: true });

    // 1. Format items for Database (Admin Printing)
    const itemsDbText = cart
        .map(i => `${i.hi} ${i.qty} ${i.unit}, рдкреИрдХреЗрдЯ: ${i.packets}`)
        .join("\n");

    // 2. Format items for WhatsApp (Clean View)
    const itemsWaText = cart
        .map((i, index) => `*${index + 1}.* ${i.hi} тЖТ *${i.qty} ${i.unit}* (${i.packets} Pkt)`)
        .join("\n");

    try {
        // Save to Firebase
        await db.collection("orders").add({
            code, name, mobile, address,
            type: delivery,
            items: itemsDbText, time
        });

        // 3. Construct the Clean WhatsApp Message
        const message = 
`ЁЯУж *рдирдпрд╛ рдСрд░реНрдбрд░ рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ* ЁЯУж
-------------------------------
ЁЯЖФ *рдСрд░реНрдбрд░ рдирдВрдмрд░:* #${code}
ЁЯУЕ *рджрд┐рдирд╛рдВрдХ:* ${time}

ЁЯСд *рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рд╡рд┐рд╡рд░рдг:*
тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
*рдирд╛рдо:* ${name}
*рдореЛрдмрд╛рдЗрд▓:* ${mobile}
*рдкрддрд╛:* ${address}
*рдбрд┐рд▓реАрд╡рд░реА:* ${delivery}

ЁЯЫТ *рд╕рд╛рдорд╛рди рдХреА рд╕реВрдЪреА:*
тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
${itemsWaText}

-------------------------------
ЁЯЩП *рд╕реБрд░рдгрд╛ рдЕрд╢реЛрдХ рдХреБрдорд╛рд░ рдЕрд░рд╡рд┐рдВрдж рдХреБрдорд╛рд░*
ЁЯУН рдорд┐рд░реНрдЪреА рдмрд╛рдЬрд╛рд░, рдЬреЛрдзрдкреБрд░`;

        window.location.href = "https://wa.me/919462439993?text=" + encodeURIComponent(message);
        
    } catch (e) {
        alert("Error: " + e.message);
    }
};
</script>

</body>
</html>